/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

import{useLexicalComposerContext as t}from"@lexical/react/LexicalComposerContext";import{createCommand as e,KEY_ARROW_DOWN_COMMAND as n,KEY_ARROW_UP_COMMAND as o,KEY_ESCAPE_COMMAND as r,KEY_TAB_COMMAND as l,KEY_ENTER_COMMAND as i,COMMAND_PRIORITY_LOW as u,$getSelection as s,$isRangeSelection as c,$isTextNode as a}from"lexical";import d,{useLayoutEffect as m,useEffect as f,useState as p,useCallback as g,useMemo as h,useRef as w}from"react";import{mergeRegister as y}from"@lexical/utils";import{jsx as v}from"react/jsx-runtime";const C="startTransition";const b="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement,x=b?m:f;class E{constructor(t){this.key=t,this.ref={current:null},this.setRefElement=this.setRefElement.bind(this)}setRefElement(t){this.ref={current:t}}}const S=t=>{const e=document.getElementById("typeahead-menu");if(!e)return;const n=e.getBoundingClientRect();n.top+n.height>window.innerHeight&&e.scrollIntoView({block:"center"}),n.top<0&&e.scrollIntoView({block:"center"}),t.scrollIntoView({block:"nearest"})};function R(t,e){const n=t.getBoundingClientRect(),o=e.getBoundingClientRect();return n.top>o.top&&n.top<o.bottom}function O(e,n,o,r){const[l]=t();f((()=>{if(null!=n&&null!=e){const t=l.getRootElement(),e=null!=t?function(t,e){let n=getComputedStyle(t);const o="absolute"===n.position,r=/(auto|scroll)/;if("fixed"===n.position)return document.body;for(let e=t;e=e.parentElement;)if(n=getComputedStyle(e),(!o||"static"!==n.position)&&r.test(n.overflow+n.overflowY+n.overflowX))return e;return document.body}(t):document.body;let i=!1,u=R(n,e);const s=function(){i||(window.requestAnimationFrame((function(){o(),i=!1})),i=!0);const t=R(n,e);t!==u&&(u=t,null!=r&&r(t))},c=new ResizeObserver(o);return window.addEventListener("resize",o),document.addEventListener("scroll",s,{capture:!0,passive:!0}),c.observe(n),()=>{c.unobserve(n),window.removeEventListener("resize",o),document.removeEventListener("scroll",s,!0)}}}),[n,l,r,o,e])}const I=e("SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND");function A({close:t,editor:e,anchorElementRef:a,resolution:d,options:m,menuRenderFn:w,onSelectOption:v,shouldSplitNodeWithQuery:C=!1,commandPriority:b=u}){const[E,R]=p(null),O=d.match&&d.match.matchingString;f((()=>{R(0)}),[O]);const A=g((n=>{e.update((()=>{const e=null!=d.match&&C?function(t){const e=s();if(!c(e)||!e.isCollapsed())return null;const n=e.anchor;if("text"!==n.type)return null;const o=n.getNode();if(!o.isSimpleText())return null;const r=n.offset,l=o.getTextContent().slice(0,r),i=t.replaceableString.length,u=r-function(t,e,n){let o=n;for(let n=o;n<=e.length;n++)t.substr(-n)===e.substr(0,n)&&(o=n);return o}(l,t.matchingString,i);if(u<0)return null;let a;return 0===u?[a]=o.splitText(r):[,a]=o.splitText(u,r),a}(d.match):null;v(n,e,t,d.match?d.match.matchingString:"")}))}),[e,C,d.match,v,t]),T=g((t=>{const n=e.getRootElement();null!==n&&(n.setAttribute("aria-activedescendant","typeahead-item-"+t),R(t))}),[e]);f((()=>()=>{const t=e.getRootElement();null!==t&&t.removeAttribute("aria-activedescendant")}),[e]),x((()=>{null===m?R(null):null===E&&T(0)}),[m,E,T]),f((()=>y(e.registerCommand(I,(({option:t})=>!(!t.ref||null==t.ref.current)&&(S(t.ref.current),!0)),b))),[e,T,b]),f((()=>y(e.registerCommand(n,(t=>{const n=t;if(null!==m&&m.length&&null!==E){const t=E!==m.length-1?E+1:0;T(t);const o=m[t];null!=o.ref&&o.ref.current&&e.dispatchCommand(I,{index:t,option:o}),n.preventDefault(),n.stopImmediatePropagation()}return!0}),b),e.registerCommand(o,(t=>{const e=t;if(null!==m&&m.length&&null!==E){const t=0!==E?E-1:m.length-1;T(t);const n=m[t];null!=n.ref&&n.ref.current&&S(n.ref.current),e.preventDefault(),e.stopImmediatePropagation()}return!0}),b),e.registerCommand(r,(e=>{const n=e;return n.preventDefault(),n.stopImmediatePropagation(),t(),!0}),b),e.registerCommand(l,(t=>{const e=t;return null!==m&&null!==E&&null!=m[E]&&(e.preventDefault(),e.stopImmediatePropagation(),A(m[E]),!0)}),b),e.registerCommand(i,(t=>null!==m&&null!==E&&null!=m[E]&&(null!==t&&(t.preventDefault(),t.stopImmediatePropagation()),A(m[E]),!0)),b))),[A,t,e,m,E,T,b]);return w(a,h((()=>({options:m,selectOptionAndCleanUp:A,selectedIndex:E,setHighlightedIndex:R})),[A,E,m]),d.match?d.match.matchingString:"")}const T="\\.,\\+\\*\\?\\$\\@\\|#{}\\(\\)\\^\\-\\[\\]\\\\/!%'\"~=<>_:;";function N(t,e){let n=getComputedStyle(t);const o="absolute"===n.position,r=e?/(auto|scroll|hidden)/:/(auto|scroll)/;if("fixed"===n.position)return document.body;for(let e=t;e=e.parentElement;)if(n=getComputedStyle(e),(!o||"static"!==n.position)&&r.test(n.overflow+n.overflowY+n.overflowX))return e;return document.body}const P=e("SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND");function L(t,{minLength:e=1,maxLength:n=75}){return g((o=>{const r=new RegExp("(^|\\s|\\()(["+t+"]((?:"+("[^"+t+T+"\\s]")+"){0,"+n+"}))$").exec(o);if(null!==r){const t=r[1],n=r[3];if(n.length>=e)return{leadOffset:r.index+t.length,matchingString:n,replaceableString:r[2]}}return null}),[n,e,t])}function _({options:e,onQueryChange:n,onSelectOption:o,onOpen:r,onClose:l,menuRenderFn:i,triggerFn:m,anchorClassName:h,commandPriority:y=u,parent:x}){const[E]=t(),[S,R]=p(null),I=function(e,n,o,r=(b?document.body:void 0),l=!0){const[i]=t(),u=w(b?document.createElement("div"):null),s=g((()=>{if(null===u.current||void 0===r)return;u.current.style.top=u.current.style.bottom;const t=i.getRootElement(),n=u.current,s=n.firstChild;if(null!==t&&null!==e){const{left:i,top:c,width:a,height:d}=e.getRect(),m=u.current.offsetHeight;if(n.style.top=`${c+m+3+(l?window.pageYOffset:0)}px`,n.style.left=`${i+window.pageXOffset}px`,n.style.height=`${d}px`,n.style.width=`${a}px`,null!==s){s.style.top=`${c}`;const e=s.getBoundingClientRect(),o=e.height,r=e.width,u=t.getBoundingClientRect();i+r>u.right&&(n.style.left=`${u.right-r+window.pageXOffset}px`),(c+o>window.innerHeight||c+o>u.bottom)&&c-u.top>o+d&&(n.style.top=`${c-o-d+(l?window.pageYOffset:0)}px`)}n.isConnected||(null!=o&&(n.className=o),n.setAttribute("aria-label","Typeahead menu"),n.setAttribute("id","typeahead-menu"),n.setAttribute("role","listbox"),n.style.display="block",n.style.position="absolute",r.append(n)),u.current=n,t.setAttribute("aria-controls","typeahead-menu")}}),[i,e,l,o,r]);f((()=>{const t=i.getRootElement();if(null!==e)return s(),()=>{null!==t&&t.removeAttribute("aria-controls");const e=u.current;null!==e&&e.isConnected&&e.remove()}}),[i,s,e]);const c=g((t=>{null!==e&&(t||n(null))}),[e,n]);return O(e,u.current,s,c),u}(S,R,h,x),T=g((()=>{R(null),null!=l&&null!==S&&l()}),[l,S]),N=g((t=>{R(t),null!=r&&null===S&&r(t)}),[r,S]);return f((()=>{const t=E.registerUpdateListener((()=>{E.getEditorState().read((()=>{const t=E._window||window,e=t.document.createRange(),o=s(),r=function(t){let e=null;return t.getEditorState().read((()=>{const t=s();c(t)&&(e=function(t){const e=t.anchor;if("text"!==e.type)return null;const n=e.getNode();if(!n.isSimpleText())return null;const o=e.offset;return n.getTextContent().slice(0,o)}(t))})),e}(E);if(!c(o)||!o.isCollapsed()||null===r||null===e)return void T();const l=m(r,E);if(n(l?l.matchingString:null),null!==l&&!function(t,e){return 0===e&&t.getEditorState().read((()=>{const t=s();if(c(t)){const e=t.anchor.getNode().getPreviousSibling();return a(e)&&e.isTextEntity()}return!1}))}(E,l.leadOffset)){const n=function(t,e,n){const o=n.getSelection();if(null===o||!o.isCollapsed)return!1;const r=o.anchorNode,l=t,i=o.anchorOffset;if(null==r||null==i)return!1;try{e.setStart(r,l),e.setEnd(r,i)}catch(t){return!1}return!0}(l.leadOffset,e,t);if(null!==n)return i=()=>N({getRect:()=>e.getBoundingClientRect(),match:l}),void(C in d?d[C](i):i())}var i;T()}))}));return()=>{t()}}),[E,m,n,S,T,N]),null===S||null===E||null===I.current?null:v(A,{close:T,resolution:S,editor:E,anchorElementRef:I,options:e,menuRenderFn:i,shouldSplitNodeWithQuery:!0,onSelectOption:o,commandPriority:y})}export{_ as LexicalTypeaheadMenuPlugin,E as MenuOption,T as PUNCTUATION,P as SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND,N as getScrollParent,L as useBasicTypeaheadTriggerMatch,O as useDynamicPositioning};
